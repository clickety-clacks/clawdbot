Now I have the full picture. Let me provide the analysis.

---

## Summary

The implementation **matches the spec well**. The diff converts Clawline from an in-app admin approval model (`pair_decision` messages) to a file-based pending→allowlist workflow. All changes are confined to `src/clawline/server.ts` and `src/clawline/domain.ts` — no touch points outside `src/clawline/`. States and rate limits align with the documented config. A few minor issues exist but nothing blocking.

---

## Blocking Issues

**None.** The implementation is functionally complete.

---

## Important Issues

### 1. Socket cleanup doesn't remove pending.json entry (server.ts:1268-1282)

When a pending socket disconnects (client closes app, network drop), `pendingSockets.delete(deviceId)` happens but the `pending.json` entry stays until TTL expiration:

```typescript
// handleSocketClose only cleans up in-memory state
for (const [deviceId, pending] of pendingSockets) {
  if (pending.socket === socket) {
    pendingSockets.delete(deviceId);  // ← in-memory only
    break;
  }
}
```

This is probably intentional (allows reconnection without re-waiting), but worth confirming. If a device abandons pairing, the entry lingers for 5 minutes. The SKILL.md says "pending.json is cleaned up automatically" which is true only on *success* (`deliverPendingApproval:882`) or *expiration* (`expirePendingPairs:1261`).

### 2. Denial cache uses pendingTtlSeconds (server.ts:700)

```typescript
const deniedDeviceTtlMs = Math.max(1, config.pairing.pendingTtlSeconds) * 1000;
```

The `deniedDevices` map remembers denied deviceIds so reconnecting clients get immediate `pair_denied`. It uses `pendingTtlSeconds` (5 min) as its TTL. This is fine but undocumented — a denied device that waits 5 minutes could retry and re-enter pending state. If intentional, add a comment; if not, consider a separate `denialTtlSeconds` config.

### 3. File watchers use polling interval (server.ts:725-729)

```typescript
watchFile(allowlistPath, { interval: 5_000 }, allowlistWatcher);
watchFile(pendingPath, { interval: 5_000 }, pendingFileWatcher);
```

`fs.watchFile` with 5s interval means up to 5 seconds latency before the provider detects external edits. For approval UX this is acceptable but could be surprising. Consider using `fs.watch` (native events) if faster reaction is needed, or document the latency.

---

## Nits

### 1. `reconcilePendingSocketsWithFile` iteration with delete (server.ts:848-862)

Iterating and deleting works in JS Maps but the control flow is harder to follow:

```typescript
function reconcilePendingSocketsWithFile() {
  for (const [deviceId, pending] of pendingSockets) {
    if (findPendingEntry(deviceId)) {
      continue;  // still in pending file, keep waiting
    }
    // ... close socket, delete from map
    pendingSockets.delete(deviceId);  // ← safe but unusual
  }
}
```

Consider collecting deviceIds to remove first, then iterating separately.

### 2. Pending count check off-by-one style (server.ts:1425-1426)

```typescript
const existingPendingEntry = findPendingEntry(deviceId);
const pendingCount = pendingFile.entries.length + (existingPendingEntry ? 0 : 1);
```

Logic is correct but reads awkwardly. Could simplify to:
```typescript
if (!existingPendingEntry && pendingFile.entries.length >= config.pairing.maxPendingRequests) { ... }
```

### 3. Removed `validateUserId` but not `USER_ID_PREFIX` usage site

The diff removes `validateUserId` and `USER_ID_PREFIX` (line 40-), but the prefix is still used in `generateUserId()` (server.ts:388):

```typescript
function generateUserId(): string {
  return `user_${randomUUID()}`;  // still uses "user_" prefix
}
```

This is fine — just noting the literal is now embedded rather than using a constant.

### 4. SKILL.md: "pending.json is cleaned up automatically"

Technically accurate only when approval succeeds. If a device is denied or disconnects, the entry stays until TTL. Could clarify: "cleaned up automatically on approval, or after 5 minutes if abandoned."

---

## Rate Limits Verification

| Config Key | Default | Implementation |
|------------|---------|----------------|
| `pairing.maxPendingRequests` | 100 | Checked at server.ts:1426 ✓ |
| `pairing.maxRequestsPerMinute` | 5 | `pairRateLimiter` at server.ts:1345 ✓ |
| `pairing.pendingTtlSeconds` | 300 | `expirePendingPairs` at server.ts:1251 ✓ |
| `auth.maxAttemptsPerMinute` | 5 | `authRateLimiter` at server.ts:1477 ✓ |
| `sessions.maxMessagesPerSecond` | 5 | `messageRateLimiter` at server.ts:1175 ✓ |

All rate limits match config defaults and are enforced at the expected locations.

---

## Files Changed

- `src/clawline/domain.ts` — Added `PendingEntry`, `PendingFile` types
- `src/clawline/server.ts` — Added pending file support, removed `pair_decision` flow

No changes outside `src/clawline/` — meets the simplicity goal.
